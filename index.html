<!DOCTYPE html>
<html>
<head>
    <title>üî¨ ESE Multi-Frequency Interactive</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', -apple-system, sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            text-align: center; background: rgba(255,255,255,0.95); 
            padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            margin-bottom: 30px; backdrop-filter: blur(10px);
        }
        h1 { color: #2c3e50; font-size: 2.8em; margin-bottom: 15px; }
        .subtitle { color: #34495e; font-size: 1.3em; }
        #plotDiv { 
            background: white; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            padding: 25px; height: 650px; margin-bottom: 25px;
        }
        .controls { 
            background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
        }
        .slider-group { margin: 20px 0; }
        .slider-group label { 
            display: block; font-weight: bold; color: #2c3e50; 
            margin-bottom: 8px; font-size: 1.1em;
        }
        .slider-group input[type="range"] { 
            width: 100%; height: 8px; border-radius: 5px; 
            background: #ecf0f1; outline: none; -webkit-appearance: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 25px; width: 25px; 
            border-radius: 50%; background: #3498db; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .slider-value { 
            background: #3498db; color: white; padding: 5px 12px; 
            border-radius: 20px; font-weight: bold; display: inline-block; margin-left: 15px;
        }
        .info { text-align: center; color: #7f8c8d; margin-top: 20px; font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ ESE Multi-Frequency</h1>
            <p class="subtitle">Monte Carlo Ray Shooting: Refractive Scattering<br>
            <small>Œ± ‚àù ŒΩ‚Åª¬≤, œÉ_source ‚àù ŒΩ‚Åª¬π | –ß–∞—Å—Ç–æ—Ç—ã: f/2, f, 2f | –¢–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞</small></p>
        </div>
        
        <div id="plotDiv"></div>
        
        <div class="controls">
            <div class="slider-group">
                <label>alpha_ref <span class="slider-value" id="alpha-val">25.0</span></label>
                <input type="range" id="alpha" min="5" max="50" value="25" step="0.5">
            </div>
            
            <div class="slider-group">
                <label>sigma_source_ref <span class="slider-value" id="sigma-val">0.83</span></label>
                <input type="range" id="sigma" min="0.2" max="2.0" value="0.83" step="0.01">
            </div>
            
            <div class="slider-group">
                <label>base_freq [GHz] <span class="slider-value" id="base-val">8.0</span></label>
                <input type="range" id="base_freq" min="4" max="16" value="8" step="0.5">
            </div>
            
            <div class="info">
                <b>–§–∏–∑–∏–∫–∞:</b> –ß–∞—Å—Ç–æ—Ç—ã = base_freq/2, base_freq, base_freq√ó2<br>
                Œ±_eff = Œ±_ref √ó (base_freq/ŒΩ)¬≤ | œÉ_eff = œÉ_ref √ó (base_freq/ŒΩ)<br>
                <i>num_beta=12000, num_u_per_beta=1200, num_bins=250 ‚Äî —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ</i>
            </div>
        </div>
    </div>

    <script>
        // üî• –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –≤–∞—à–µ–≥–æ mc_ray_shooting (Monte Carlo)
        function mc_ray_shooting(alpha, sigma_source, u_min=-25, u_max=25, num_beta=12000, 
                                num_u_per_beta=1200, u_prime_min=-25, u_prime_max=25, num_bins=250) {
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è beta_s_samples (–≥–∞—É—Å—Å–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫)
            let beta_s_samples = [];
            for(let i = 0; i < num_beta; i++) {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                let r = Math.sqrt(-2*Math.log(u));
                let theta = 2*Math.PI*v;
                beta_s_samples.push(sigma_source * r * Math.cos(theta));
            }
            
            // Lensed rays
            let u_prime_lensed = [];
            let u = [];
            for(let i = 0; i <= num_u_per_beta; i++) {
                u.push(u_min + (u_max-u_min)*i/num_u_per_beta);
            }
            
            for(let beta_s of beta_s_samples) {
                for(let ui of u) {
                    let deflection = alpha * ui * Math.exp(-ui*ui);
                    u_prime_lensed.push(ui + deflection + beta_s);
                }
            }
            
            // Unlensed rays
            let u_prime_unlensed = [];
            for(let beta_s of beta_s_samples) {
                for(let ui of u) {
                    u_prime_unlensed.push(ui + beta_s);
                }
            }
            
            // –ë–∏–Ω—ã —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ
            let bins = [];
            for(let i = 0; i <= num_bins; i++) {
                bins.push(u_prime_min + (u_prime_max-u_prime_min)*i/num_bins);
            }
            
            // –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (density=True)
            let hist_lensed = new Array(num_bins).fill(0);
            let hist_unlensed = new Array(num_bins).fill(0);
            
            let total_lensed = u_prime_lensed.length;
            let total_unlensed = u_prime_unlensed.length;
            let bin_width = (u_prime_max - u_prime_min) / num_bins;
            
            for(let val of u_prime_lensed) {
                for(let i = 0; i < num_bins; i++) {
                    if(val >= bins[i] && val < bins[i+1]) {
                        hist_lensed[i]++;
                        break;
                    }
                }
            }
            
            for(let val of u_prime_unlensed) {
                for(let i = 0; i < num_bins; i++) {
                    if(val >= bins[i] && val < bins[i+1]) {
                        hist_unlensed[i]++;
                        break;
                    }
                }
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è density=True
            let bin_centers = [];
            let intensity = [];
            for(let i = 0; i < num_bins; i++) {
                bin_centers.push((bins[i] + bins[i+1])/2);
                let density_lensed = hist_lensed[i] / (total_lensed * bin_width);
                let density_unlensed = hist_unlensed[i] / (total_unlensed * bin_width);
                intensity.push(density_unlensed > 0 ? density_lensed / density_unlensed : 0);
            }
            
            return {bin_centers: bin_centers, intensity: intensity};
        }
        
        // –ú—É–ª—å—Ç–∏—á–∞—Å—Ç–æ—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–¢–û–ß–ù–û –∫–∞–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ)
        function multi_frequency_ese(alpha_ref, sigma_ref, base_freq) {
            let freqs = [base_freq/2, base_freq, base_freq*2];
            let results = {};
            
            for(let nu of freqs) {
                let scale_sigma = (base_freq / nu);
                let scale_alpha = Math.pow(base_freq / nu, 2);
                
                let result = mc_ray_shooting(
                    alpha_ref * scale_alpha, 
                    sigma_ref * scale_sigma
                );
                results[nu] = result;
            }
            return {freqs: freqs, results: results};
        }
        
        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø
        function updatePlot() {
            let alpha_ref = parseFloat(document.getElementById('alpha').value);
            let sigma_ref = parseFloat(document.getElementById('sigma').value);
            let base_freq = parseFloat(document.getElementById('base_freq').value);
            
            let data = multi_frequency_ese(alpha_ref, sigma_ref, base_freq);
            let freqs = data.freqs;
            let results = data.results;
            
            let traces = [];
            let colors = ['#e74c3c', '#3498db', '#27ae60'];
            let linestyles = ['solid', 'dash', 'dot'];
            
            for(let i = 0; i < freqs.length; i++) {
                let nu = freqs[i];
                let scale_alpha = Math.pow(base_freq/nu, 2);
                
                traces.push({
                    x: results[nu].bin_centers,
                    y: results[nu].intensity,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: colors[i],
                        width: 3.5,
                        dash: linestyles[i]
                    },
                    name: `${nu.toFixed(1)} GHz (Œ±=${(alpha_ref*scale_alpha).toFixed(1)})`
                });
            }
            
            let layout = {
                title: {
                    text: `ESE Multi-Frequency: Œ±_ref=${alpha_ref.toFixed(1)}, œÉ_ref=${sigma_ref.toFixed(2)}, base_freq=${base_freq.toFixed(1)} GHz<br>
                    <sub>–ß–∞—Å—Ç–æ—Ç—ã: ${base_freq/2.toFixed(1)}/${base_freq.toFixed(1)}/${(base_freq*2).toFixed(1)} GHz | œÉ‚àùŒΩ‚Åª¬π, Œ±‚àùŒΩ‚Åª¬≤ | num_beta=12000, num_bins=250</sub>`,
                    font: {size: 22, family: 'Segoe UI, sans-serif'}
                },
                xaxis: {
                    title: "u'",
                    range: [-20, 20],
                    gridcolor: 'rgba(128,128,128,0.2)'
                },
                yaxis: {
                    title: "I / I_unlensed",
                    gridcolor: 'rgba(128,128,128,0.2)'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: {family: 'Segoe UI, sans-serif', size: 14},
                legend: {x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)', bordercolor: 'rgba(0,0,0,0.1)'},
                height: 600,
                margin: {l: 70, r: 40, t: 100, b: 60},
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('plotDiv', traces, layout, {responsive: true});
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
        document.getElementById('alpha').addEventListener('input', function() {
            document.getElementById('alpha-val').textContent = this.value;
            updatePlot();
        });
        
        document.getElementById('sigma').addEventListener('input', function() {
            document.getElementById('sigma-val').textContent = parseFloat(this.value).toFixed(2);
            updatePlot();
        });
        
        document.getElementById('base_freq').addEventListener('input', function() {
            document.getElementById('base-val').textContent = this.value;
            updatePlot();
        });
        
        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        updatePlot();
    </script>
</body>
</html>

